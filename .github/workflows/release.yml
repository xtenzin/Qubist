# GitHub Actions Release 工作流
# GitHub Actions Release workflow
name: Release

# 触发条件：当创建或编辑 Release 时，也支持手动触发
# Trigger conditions: when creating or editing a release, also supports manual trigger
on:
  release:
    types: [created, edited]
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag name to build'
        required: true
        default: 'v0.1.1'

jobs:
  # 构建和上传 Release 文件
  # Build and upload Release files
  build-and-release:
    runs-on: ubuntu-latest
    
    # 授予必要的权限以创建和更新 Release
    # Grant necessary permissions to create and update releases
    permissions:
      contents: write  # 需要此权限来创建/更新 Release 和上传文件
                       # Required to create/update releases and upload files

    steps:
      # 获取 tag 名称
      # Get tag name
      - name: Get tag name
        id: tag
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "tag=${{ github.event.inputs.tag }}" >> $GITHUB_OUTPUT
          else
            echo "tag=${{ github.event.release.tag_name }}" >> $GITHUB_OUTPUT
          fi

      # 检出代码（手动触发时检出对应的 tag）
      # Checkout code (checkout corresponding tag when manually triggered)
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.tag.outputs.tag }}

      # 设置 Node.js
      # Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
          cache-dependency-path: src/package-lock.json

      # 安装依赖
      # Install dependencies
      - name: Install dependencies
        working-directory: ./src
        run: npm ci

      # 构建项目
      # Build project
      - name: Build project
        working-directory: ./src
        run: npm run build

      # 验证构建产物
      # Verify build artifacts
      - name: List dist directory
        run: |
          ls -la dist/ || echo "dist directory not found"
          pwd

      # 创建压缩包
      # Create release archive
      - name: Create release archive
        run: |
          if [ -d "dist" ]; then
            echo "Creating archives from dist directory..."
            cd dist
            tar -czf ../qubist-${{ steps.tag.outputs.tag }}.tar.gz .
            cd ..
            zip -r qubist-${{ steps.tag.outputs.tag }}.zip dist/
            echo "Archives created:"
            ls -lh qubist-${{ steps.tag.outputs.tag }}.*
            echo "File sizes:"
            du -h qubist-${{ steps.tag.outputs.tag }}.*
          else
            echo "Error: dist directory not found!"
            exit 1
          fi

      # 验证文件存在
      # Verify files exist
      - name: Verify release files exist
        run: |
          echo "Current directory:"
          pwd
          echo "Files to upload:"
          ls -lah qubist-${{ steps.tag.outputs.tag }}.*
          if [ ! -f "qubist-${{ steps.tag.outputs.tag }}.tar.gz" ] || [ ! -f "qubist-${{ steps.tag.outputs.tag }}.zip" ]; then
            echo "Error: Required files not found!"
            exit 1
          fi

      # 上传 Release 文件（使用 GitHub CLI 上传，确保能更新已存在的 Release）
      # Upload Release files (using GitHub CLI to ensure updates to existing releases)
      - name: Upload Release assets
        run: |
          echo "Uploading files to release ${{ steps.tag.outputs.tag }}"
          
          # 检查 Release 是否存在
          # Check if release exists
          if gh release view ${{ steps.tag.outputs.tag }} >/dev/null 2>&1; then
            echo "Release exists, uploading files..."
            gh release upload ${{ steps.tag.outputs.tag }} \
              qubist-${{ steps.tag.outputs.tag }}.tar.gz \
              qubist-${{ steps.tag.outputs.tag }}.zip \
              --clobber
          else
            echo "Release does not exist, creating it with files..."
            gh release create ${{ steps.tag.outputs.tag }} \
              --title "${{ steps.tag.outputs.tag }}" \
              --notes "Release ${{ steps.tag.outputs.tag }}" \
              qubist-${{ steps.tag.outputs.tag }}.tar.gz \
              qubist-${{ steps.tag.outputs.tag }}.zip
          fi
          
          echo "Upload completed. Listing release assets:"
          gh release view ${{ steps.tag.outputs.tag }} --json assets -q '.assets[].name'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
